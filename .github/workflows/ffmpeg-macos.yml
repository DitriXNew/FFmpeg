# FFmpeg macOS ARM64 build with whisper.cpp for Flutter integration
# Based on examples from: github.com/ggml-org/whisper.cpp and FFmpeg official docs
name: build-ffmpeg-macos-arm64-lgpl-whisper

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  FFMPEG_TAG: "n8.0"
  INSTALL_PREFIX: "${{ github.workspace }}/install"

jobs:
  build-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          export HOMEBREW_NO_AUTO_UPDATE=1
          brew install cmake ninja pkg-config nasm yasm \
               libvpx aom opus libvorbis libogg

      - name: Build and install whisper.cpp
        run: |
          set -eux
          
          # Clone whisper.cpp
          git clone --depth=1 https://github.com/ggml-org/whisper.cpp
          cd whisper.cpp
          
          # Configure build
          cmake -B build \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr/local \
                -DBUILD_SHARED_LIBS=OFF \
                -DWHISPER_BUILD_TESTS=OFF \
                -DWHISPER_BUILD_EXAMPLES=OFF
          
          # Build
          cmake --build build --config Release --parallel
          
          # Install to system (creates whisper.pc automatically)
          sudo cmake --install build
          
          # Verify installation
          echo "=== Installation verification ==="
          ls -la /usr/local/lib/pkgconfig/whisper.pc || echo "No whisper.pc found"
          ls -la /usr/local/include/whisper.h || echo "No whisper.h found"
          ls -la /usr/local/lib/libwhisper.* || echo "No whisper libs found"
          
          echo "=== PKG-CONFIG test ==="
          pkg-config --exists whisper && echo "✅ pkg-config found whisper" || echo "❌ pkg-config failed"
          pkg-config --modversion whisper 2>/dev/null || echo "Cannot get version"
          pkg-config --cflags whisper 2>/dev/null || echo "Cannot get cflags"
          pkg-config --libs whisper 2>/dev/null || echo "Cannot get libs"

      - name: Build FFmpeg with whisper support
        run: |
          set -eux
          
          # Clone FFmpeg
          git clone https://github.com/FFmpeg/FFmpeg ffmpeg-src
          cd ffmpeg-src
          git checkout "$FFMPEG_TAG"
          
          # Configure FFmpeg with LGPL settings + whisper
          ./configure \
            --prefix="$INSTALL_PREFIX" \
            --arch=arm64 \
            --target-os=darwin \
            --enable-whisper \
            --enable-videotoolbox \
            --disable-gpl \
            --disable-nonfree \
            --disable-static \
            --enable-shared \
            --enable-libvpx \
            --enable-libaom \
            --enable-libopus \
            --enable-libvorbis \
            --disable-debug \
            --disable-doc \
            --enable-pic
          
          # Build
          make -j"$(sysctl -n hw.ncpu)"
          make install

      - name: Verify build and LGPL compliance
        run: |
          echo "=== FFmpeg build verification ==="
          "$INSTALL_PREFIX/bin/ffmpeg" -version
          echo ""
          
          echo "=== Whisper filter check ==="
          "$INSTALL_PREFIX/bin/ffmpeg" -filters | grep whisper || echo "❌ No whisper filter"
          echo ""
          
          echo "=== LGPL compliance check ==="
          "$INSTALL_PREFIX/bin/ffmpeg" -buildconf
          if "$INSTALL_PREFIX/bin/ffmpeg" -buildconf | grep -q -- "--enable-gpl"; then
            echo "❌ ERROR: GPL found in build!"
            exit 1
          fi
          echo "✅ LGPL compliance verified"
          echo ""
          
          echo "=== Dynamic libraries ==="
          ls -la "$INSTALL_PREFIX/lib/"*.dylib
          echo ""
          
          echo "=== Library dependencies ==="
          otool -L "$INSTALL_PREFIX/bin/ffmpeg" | head -20

      - name: Package for Flutter
        run: |
          cd "$INSTALL_PREFIX"
          
          # Create package with binaries, libraries and headers
          tar -czf ffmpeg-macos-arm64-lgpl-whisper.tar.gz \
            bin/ffmpeg \
            bin/ffprobe \
            lib/*.dylib \
            include/
          
          echo "=== Package contents ==="
          tar -tzf ffmpeg-macos-arm64-lgpl-whisper.tar.gz
          echo ""
          
          echo "=== Package size ==="
          ls -lh ffmpeg-macos-arm64-lgpl-whisper.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64-lgpl-whisper
          path: ${{ env.INSTALL_PREFIX }}/ffmpeg-macos-arm64-lgpl-whisper.tar.gz
